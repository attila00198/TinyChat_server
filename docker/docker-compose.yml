version: '3.8'
# Development/Testing configuration
# For production, use: docker-compose -f docker-compose.prod.yml up -d
# See SERVER_DEPLOYMENT.md for production setup instructions

services:
  tinychat:
    # Use pre-built image from Docker Hub (recommended for production)
    image: attila00198/tinychat-server:latest
    
    # Or build locally from Dockerfile (uncomment for development):
    # build:
    #   context: ..
    #   dockerfile: docker/Dockerfile
    
    container_name: tinychat-server
    
    # Server configuration via environment variables
    environment:
      # Network settings
      - HOST=0.0.0.0
      - PORT=8765
      
      # Moderator password (change this!)
      - MOD_PASSWORD=admin123
      
      # SSL/TLS configuration (set USE_SSL=false to disable)
      - USE_SSL=true
      - SSL_CERT_PATH=/certs/fullchain.pem
      - SSL_KEY_PATH=/certs/privkey.pem
    
    # Port mapping: host:container
    ports:
      - "8000:8765"
    
    # Mount certificate files for TLS
    # NOTE: Certbot symlinks are in /live/, but actual files are in /archive/
    # We mount /archive/ to avoid symlink resolution issues
    volumes:
      - /etc/letsencrypt/archive/krassus.ddns.net-0001:/certs:ro
    
    # Restart policy
    restart: unless-stopped
    
    # Optional: healthcheck
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; socket.create_connection(('localhost', 8765), timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Optional: logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
